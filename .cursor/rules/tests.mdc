---
description: Правила тестирования критичных потоков
globs: tests/**/*.{py,ts}
alwaysApply: false
---

# Правила тестов

## Что тестируем обязательно
1. Сборка промпта для LLM.
2. Менеджер контекста (добавление реплик, резюме).
3. WebSocket поток: подключение, отправка аудио, получение ответа.
4. STT на эталонном аудио‑файле.
5. E2E: запуск/остановка записи.

## Структура
```
tests/
  unit/           # Быстрые изолированные тесты
  integration/    # Тесты с реальными зависимостями
  e2e/            # Playwright сценарии
  fixtures/       # Тестовые данные (аудио, JSON)
```

## Правила
- Имена: `test_<что>_<условие>_<ожидание>.py`.
- Фикстуры — в `conftest.py`.
- Мокай внешние API (OpenRouter) в unit‑тестах.
- Интеграционные тесты запускай с флагом `--integration`.

## Пример (pytest)
```python
def test_context_manager_adds_utterance():
    """Проверяет добавление реплики в контекст."""
    ctx = ContextManager()
    ctx.add("user", "Привет")
    assert ctx.history[-1] == {"role": "user", "text": "Привет"}
```

## CI
- Тесты запускаются на каждый PR.
- Минимальное покрытие критичных модулей — 80 %.
