# ADR-003: Фильтр галлюцинаций Whisper (титры и заставки)

**Статус**: Принято  
**Дата**: 2026-01-30

## Контекст

При использовании OpenAI Whisper API (`whisper-1`) в транскрипте появляются фразы, которых **нет в аудио**: например «С вами был Игорь Негода», «До скорой встречи», «Спасибо за внимание!», «Продолжение следует…». Пользователь подтвердил: посторонних звуков (ТВ, радио, вкладка) нет — это **галлюцинации модели**.

## Ресерч

### Почему так происходит

- Whisper известен тем, что на **тишине, коротких или шумных чанках** «додумывает» текст вместо того, чтобы вернуть пустоту.
- В сообществах OpenAI (например [Whisper API hallucinating on empty sections](https://community.openai.com/t/whisper-api-hallucinating-on-empty-sections/93646)) это многократно описано: типичные примеры — «Thanks for watching», «Subtítulos realizados por…», заставки и титры.
- Модель обучена на большом объёме субтитров и заставок, поэтому при неопределённом/тихом входе часто выдаёт именно такие фразы.

### Что предлагает API

- **Параметр `prompt`** ([Speech to text — Prompting](https://platform.openai.com/docs/guides/speech-to-text#prompting)): для `whisper-1` документация указывает, что промпт задаёт **стиль и контекст** (пунктуация, орфография, продолжение предыдущего сегмента). Явного «не выдумывай на тишине» API не описывает; для whisper-1 контроль через промпт ограничен.
- **Параметр `hallucination_silence`** есть в open-source Whisper, в **OpenAI Whisper API** его нет.
- **Предобработка (ffmpeg, VAD)** — возможна, но усложняет пайплайн и не устраняет галлюцинации на границах речи/тишины.

### Вывод

Надёжный способ в нашем стеке — **не показывать** такие фразы пользователю: фильтровать их на бэкенде по списку/паттернам и не отправлять в WebSocket и не сохранять в транскрипт.

## Решение

1. **Фильтр на бэкенде** (в [apps/api/.../routers/audio.py](apps/api/src/voicecopilot_api/routers/audio.py)): расширить логику `_should_skip_transcription` — добавить паттерны типичных фраз ТВ/радио и заставок (например: «с вами был», «до скорой встречи», «спасибо за внимание», «продолжение следует», уже есть «редактор субтитров», «корректор»). Если текст совпадает с паттерном — не отправлять клиенту и не писать в `transcript_entries`.
2. **Опционально** — попробовать передавать в Whisper API `prompt` в духе контекста («Разговор на русском.») для согласованности стиля; не полагаться на него как на единственную защиту от галлюцинаций.
3. **Документация**: в SETUP/Troubleshooting кратко описать, что часть «мусорных» фраз в транскрипте — известные галлюцинации Whisper и что мы их отфильтровываем.

## Последствия

- Пользователь не видит типичные заставки/титры в транскрипте даже при галлюцинациях.
- Новые устойчивые фразы-галлюцинации при необходимости можно добавлять в список паттернов.

## Ссылки

- [Whisper API — Create transcription](https://platform.openai.com/docs/api-reference/audio/createTranscription) (параметры `prompt`, `language`).
- [Speech to text — Prompting](https://platform.openai.com/docs/guides/speech-to-text#prompting).
- [Whisper API hallucinating on empty sections](https://community.openai.com/t/whisper-api-hallucinating-on-empty-sections/93646).
